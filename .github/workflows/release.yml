# Build and publish hurry releases to S3.
#
# Triggered on version tags (v*). Builds binaries for all supported platforms
# in parallel on native runners, then uploads to S3.
#
# This workflow replicates the logic from scripts/release.sh for CI.
name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (skip S3 upload)"
                type: boolean
                default: false

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always
    AWS_REGION: us-west-1
    BUCKET: hurry-releases

jobs:
    prepare:
        name: Prepare
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            tag: ${{ steps.version.outputs.tag }}
            prerelease: ${{ steps.version.outputs.prerelease }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from tag
              id: version
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                    TAG="${{ github.ref_name }}"
                    VERSION="${TAG#v}"
                  elif [[ "${{ inputs.dry_run }}" == "true" ]]; then
                    # Allow dry runs on any branch using git describe (same as hurry's build.rs)
                    TAG=$(git describe --always --tags)
                    VERSION="${TAG#v}"
                    echo "::notice::Dry run on non-tag ref, using git describe version: $TAG"
                  else
                    echo "::error::Release workflow must be triggered by a version tag (v*)"
                    exit 1
                  fi

                  # Detect prerelease (anything with a dash after X.Y.Z, or non-semver like commit hashes)
                  if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    PRERELEASE=false
                  else
                    PRERELEASE=true
                  fi

                  echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
                  echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
                  echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
                  echo "Releasing version: ${VERSION} (prerelease: ${PRERELEASE})"

    build:
        name: Build ${{ matrix.target }}
        needs: prepare
        runs-on: ${{ matrix.runner }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # macOS builds (both targets on macos-latest via --target)
                    - target: x86_64-apple-darwin
                      runner: macos-latest
                      cross: false
                    - target: aarch64-apple-darwin
                      runner: macos-latest
                      cross: false

                    # Linux GNU builds
                    - target: x86_64-unknown-linux-gnu
                      runner: ubuntu-latest
                      cross: false
                    - target: aarch64-unknown-linux-gnu
                      runner: ubuntu-latest
                      cross: true

                    # Linux musl builds
                    - target: x86_64-unknown-linux-musl
                      runner: ubuntu-latest
                      cross: true
                    - target: aarch64-unknown-linux-musl
                      runner: ubuntu-latest
                      cross: true

                    # Windows build using cross (simpler than native MinGW setup)
                    - target: x86_64-pc-windows-gnu
                      runner: ubuntu-latest
                      cross: true

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              run: |
                  rustup toolchain install stable
                  rustup target add ${{ matrix.target }}

            - name: Install cargo-cross
              if: matrix.cross
              uses: taiki-e/install-action@v2
              with:
                  tool: cargo-cross
                  checksum: true

            - name: Build with cargo cross
              if: matrix.cross
              run: cargo cross build --target ${{ matrix.target }} --package hurry --release

            - name: Build native
              if: ${{ !matrix.cross }}
              run: cargo build --target ${{ matrix.target }} --package hurry --release

            - name: Package binary
              id: package
              shell: bash
              run: |
                  TARGET="${{ matrix.target }}"
                  ARCHIVE_NAME="hurry-${TARGET}"
                  ARCHIVE_DIR="artifacts/${ARCHIVE_NAME}"
                  mkdir -p "${ARCHIVE_DIR}"

                  # Copy binary (Windows has .exe extension)
                  if [[ "$TARGET" == *"windows"* ]]; then
                    cp "target/${TARGET}/release/hurry.exe" "${ARCHIVE_DIR}/"
                  else
                    cp "target/${TARGET}/release/hurry" "${ARCHIVE_DIR}/"
                  fi

                  # Include README
                  cp README.md "${ARCHIVE_DIR}/"

                  # Create tarball
                  (cd artifacts && tar -czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}")
                  rm -rf "${ARCHIVE_DIR}"

                  echo "archive=artifacts/${ARCHIVE_NAME}.tar.gz" >> "$GITHUB_OUTPUT"

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: hurry-${{ matrix.target }}
                  path: ${{ steps.package.outputs.archive }}
                  if-no-files-found: error
                  retention-days: 7

    release:
        name: Release
        needs: [prepare, build]
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  pattern: hurry-*
                  merge-multiple: true

            - name: List artifacts
              run: ls -la artifacts/

            - name: Generate checksums
              working-directory: artifacts
              run: |
                  sha256sum *.tar.gz > checksums.txt
                  echo "Generated checksums:"
                  cat checksums.txt

            - name: Configure AWS credentials
              if: ${{ !inputs.dry_run }}
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.HURRY_RELEASE_ROLE }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Upload versioned release to S3
              if: ${{ !inputs.dry_run }}
              run: |
                  TAG="${{ needs.prepare.outputs.tag }}"
                  echo "Uploading to s3://${BUCKET}/releases/${TAG}/"

                  aws s3 sync artifacts/ "s3://${BUCKET}/releases/${TAG}/" \
                    --exclude "*" \
                    --include "*.tar.gz" \
                    --include "checksums.txt" \
                    --cache-control "public, max-age=31536000, immutable"

            - name: Update latest pointer (stable releases only)
              if: ${{ !inputs.dry_run && needs.prepare.outputs.prerelease == 'false' }}
              run: |
                  echo "Updating latest release pointer"

                  aws s3 sync artifacts/ "s3://${BUCKET}/releases/latest/" \
                    --exclude "*" \
                    --include "*.tar.gz" \
                    --include "checksums.txt" \
                    --cache-control "no-cache, must-revalidate"

            - name: Update versions.json
              if: ${{ !inputs.dry_run }}
              run: |
                  VERSION="${{ needs.prepare.outputs.version }}"
                  TAG="${{ needs.prepare.outputs.tag }}"
                  PRERELEASE="${{ needs.prepare.outputs.prerelease }}"
                  PUBLISHED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

                  # Download existing versions.json or create empty one
                  aws s3 cp "s3://${BUCKET}/releases/versions.json" versions.json 2>/dev/null || echo '{"latest": "", "versions": []}' > versions.json

                  # Build platforms array
                  PLATFORMS='["x86_64-apple-darwin","aarch64-apple-darwin","x86_64-unknown-linux-gnu","aarch64-unknown-linux-gnu","x86_64-unknown-linux-musl","aarch64-unknown-linux-musl","x86_64-pc-windows-gnu"]'

                  # Update versions.json
                  jq --arg version "$VERSION" \
                     --arg prerelease "$PRERELEASE" \
                     --arg published_at "$PUBLISHED_AT" \
                     --argjson platforms "$PLATFORMS" \
                     '
                     .versions |= ([{
                         version: $version,
                         prerelease: ($prerelease == "true"),
                         published_at: $published_at,
                         platforms: $platforms
                     }] + .) |
                     if ($prerelease == "false") then
                         .latest = $version
                     else
                         .
                     end
                     ' versions.json > versions.json.tmp
                  mv versions.json.tmp versions.json

                  # Upload updated versions.json
                  aws s3 cp versions.json "s3://${BUCKET}/releases/versions.json" \
                    --cache-control "no-cache, must-revalidate"

            - name: Generate changelog
              if: ${{ !inputs.dry_run && needs.prepare.outputs.prerelease == 'false' }}
              run: |
                  git fetch --tags
                  ./scripts/release.sh --generate-changelog > CHANGELOG.md

            - name: Upload changelog
              if: ${{ !inputs.dry_run && needs.prepare.outputs.prerelease == 'false' }}
              run: |
                  aws s3 cp CHANGELOG.md "s3://${BUCKET}/releases/CHANGELOG.md" \
                    --cache-control "no-cache, must-revalidate"

            - name: Upload install script
              if: ${{ !inputs.dry_run }}
              run: |
                  aws s3 cp scripts/install.sh "s3://${BUCKET}/install.sh" \
                    --cache-control "no-cache, must-revalidate"

            - name: Write release summary
              if: ${{ !inputs.dry_run }}
              run: |
                  TAG="${{ needs.prepare.outputs.tag }}"
                  VERSION="${{ needs.prepare.outputs.version }}"

                  echo "## Release $TAG" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Install" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo '```bash' >> $GITHUB_STEP_SUMMARY
                  echo "curl -sSfL https://${BUCKET}.s3.amazonaws.com/install.sh | bash" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Downloads" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Platform | Link |" >> $GITHUB_STEP_SUMMARY
                  echo "| -------- | ---- |" >> $GITHUB_STEP_SUMMARY
                  for target in x86_64-apple-darwin aarch64-apple-darwin x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu x86_64-unknown-linux-musl aarch64-unknown-linux-musl x86_64-pc-windows-gnu; do
                    echo "| $target | [hurry-${target}.tar.gz](https://${BUCKET}.s3.amazonaws.com/releases/${TAG}/hurry-${target}.tar.gz) |" >> $GITHUB_STEP_SUMMARY
                  done
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Verification" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- [checksums.txt](https://${BUCKET}.s3.amazonaws.com/releases/${TAG}/checksums.txt)" >> $GITHUB_STEP_SUMMARY
                  echo "- [versions.json](https://${BUCKET}.s3.amazonaws.com/releases/versions.json)" >> $GITHUB_STEP_SUMMARY

            - name: Write dry run summary
              if: ${{ inputs.dry_run }}
              run: |
                  TAG="${{ needs.prepare.outputs.tag }}"

                  echo "## Dry Run - $TAG" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "> [!NOTE]" >> $GITHUB_STEP_SUMMARY
                  echo "> No uploads performed. This was a dry run." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  ls -la artifacts/ >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Checksums" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  cat artifacts/checksums.txt >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
