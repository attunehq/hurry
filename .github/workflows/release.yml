name: release

# Pushes standard releases on `vX.Y.Z` tags.
# Pushes prereleases on pushes to `main`.
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    branches:
      - main

permissions:
  contents: write # Needed to write release contents

jobs:
  tagged:
    runs-on: ubuntu-latest

    outputs:
      sha: ${{ steps.compute.outputs.sha }}
      version: ${{ steps.compute.outputs.version }}
      release: ${{ steps.compute.outputs.release }}
      prerelease: ${{ steps.compute.outputs.prerelease }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
    - uses: actions/checkout@v4

    - name: compute
      id: compute
      shell: bash
      run: |
        SHA=$(git rev-parse --short HEAD)
        echo "sha=$SHA" >> "$GITHUB_OUTPUT"
        if [[ "${{ github.event_name }}" == "push" && "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
          # For tagged builds, use the tag with its `v` prefix stripped
          RELEASE=${GITHUB_REF#refs/tags/}
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "release=$RELEASE" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "prerelease=false" >> "$GITHUB_OUTPUT"
        else
          # For non-tag builds, use `0.0.0-{date}-{sha}`
          DATE=$(date '+%Y-%m-%d')
          SHA=$(git rev-parse --short HEAD)
          PSUEDOTAG="0.0.0-$DATE-$SHA"
          echo "release=v$PSUEDOTAG" >> "$GITHUB_OUTPUT"
          echo "version=$PSUEDOTAG" >> "$GITHUB_OUTPUT"
          echo "prerelease=true" >> "$GITHUB_OUTPUT"
        fi

    - name: changelog
      id: changelog
      run: |
        if [[ "${{ steps.compute.outputs.prerelease }}" == "true" ]]; then
          gh api repos/attunehq/hurry/commits/${{ steps.compute.outputs.sha }} --jq '.commit.message | "- " + .' > version_changelog.txt
        else
          LATEST_TAG=${{ steps.compute.outputs.release }}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 --exclude=$LATEST_TAG)
          gh api repos/attunehq/hurry/compare/$PREVIOUS_TAG...$LATEST_TAG --jq '.commits[] | .commit.message | "- " + .' > version_changelog.txt
        fi
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        cat version_changelog.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: build / ${{ matrix.os }} / ${{ matrix.target }}
    needs: tagged
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Native runners, no need for cross compilation
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
          - target: x86_64-apple-darwin
            os: macos-latest
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

          # Cross compilation needed
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true

    steps:
      - uses: actions/checkout@v4
      - name: install rust
        run: |
          rustup toolchain install stable
          rustup target add ${{ matrix.target }}
          rustup show
      - name: install `cross`
        uses: taiki-e/install-action@v2
        if: matrix.cross
        with:
          tool: cross
      - name: install `cargo-set-version`
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-set-version

      - name: set version
        shell: bash
        run: cargo set-version ${{ needs.tagged.outputs.version }}

      - name: build
        shell: bash
        run: |
          CARGO_COMMAND=${{ matrix.cross && 'cross' || 'cargo' }}
          $CARGO_COMMAND build --release --target ${{ matrix.target }}

      - name: prepare
        shell: bash
        run: |
          TARGET_DIR="target/${{ matrix.target }}/release"
          ARTIFACT_NAME="hurry-${{ matrix.target }}"
          mkdir -p "$ARTIFACT_NAME"

          cp "$TARGET_DIR/hurry" "$ARTIFACT_NAME/"
          cp README.md "$ARTIFACT_NAME/"
          tar -czf "$ARTIFACT_NAME.tar.gz" "$ARTIFACT_NAME"

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: hurry-${{ matrix.target }}
          path: hurry-${{ matrix.target }}.tar.gz
          if-no-files-found: warn

  create-checksums:
    name: checksums
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: generate
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec sha256sum {} \; > checksums.txt
          cat checksums.txt

      - name: upload
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: artifacts/checksums.txt

  release:
    name: push
    needs: [tagged, build, create-checksums]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: render
        run: |
            echo "release<<EOF" >> $GITHUB_OUTPUT
            echo <<EOF >> $GITHUB_OUTPUT
            ## Changes in ${{ needs.tagged.outputs.release }}

            ${{ needs.tagged.outputs.changelog }}

            ## Installation

            Download the appropriate binary for your system and architecture:

            | Platform | Architecture | Download |
            | -------- | ------------ | -------- |
            | macOS    | x86_64       | [hurry-x86_64-apple-darwin.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-apple-darwin.tar.gz) |
            | macOS    | arm64        | [hurry-aarch64-apple-darwin.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-apple-darwin.tar.gz) |
            | Linux    | x86_64       | [hurry-x86_64-unknown-linux-gnu.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-unknown-linux-gnu.tar.gz) |
            | Linux    | arm64        | [hurry-aarch64-unknown-linux-gnu.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-unknown-linux-gnu.tar.gz) |
            | Linux    | x86_64 (musl) | [hurry-x86_64-unknown-linux-musl.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-x86_64-unknown-linux-musl.tar.gz) |
            | Linux    | arm64 (musl) | [hurry-aarch64-unknown-linux-musl.tar.gz](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/hurry-aarch64-unknown-linux-musl.tar.gz) |

            See [checksums.txt](https://github.com/attunehq/hurry/releases/download/${{ needs.tagged.outputs.release }}/checksums.txt) for file checksums.
            EOF
            echo "EOF" >> $GITHUB_OUTPUT

      - name: create
        if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/checksums.txt
          draft: false
          body: ${{ steps.render.outputs.release }}
          prerelease: ${{ needs.tagged.outputs.prerelease }}
