import{a,j as e}from"./index-BBJX7inb.js";import{u as _}from"./useApi-Dn3zf_yp.js";import{B as A}from"./Badge-Bgbs80Ll.js";import{B as o}from"./Button-B1BdtBaM.js";import{C as z,b as O,a as $}from"./Card-CFtCxk2z.js";import{L as w,I as B}from"./Label-JIDdilb1.js";import{M as S}from"./Modal-CHOY4886.js";import{u as L}from"./ToastProvider-C_5kRdyY.js";import{u as M,T as D}from"./orgContext-C7qTc9MO.js";import{P as F}from"./plus-BqUPOgIb.js";import{B as q}from"./bot-pGJOJMnB.js";import{C as U}from"./copy-DvjwGVz6.js";import"./chunk-WWGJGFF6-BoMxq1lg.js";import"./session-BZ9GPMw7.js";import"./createLucideIcon-BrAVhkf1.js";function ne(){const r=L(),{request:l,signedIn:c}=_(),{orgId:d,role:I}=M(),[m,f]=a.useState(null),[E,y]=a.useState(!1),[P,x]=a.useState(!1),[b,N]=a.useState(""),[v,g]=a.useState(""),[i,h]=a.useState(null),C=a.useMemo(()=>(m==null?void 0:m.bots)??[],[m]),u=I==="admin",p=a.useCallback(async()=>{if(c){y(!0);try{const t=await l({path:`/api/v1/organizations/${d}/bots`});f(t)}catch(t){if(t&&typeof t=="object"&&"status"in t&&t.status===401)return;const n=t&&typeof t=="object"&&"message"in t?String(t.message):"";r.push({kind:"error",title:"Failed to load bots",detail:n}),f(null)}finally{y(!1)}}},[c,d,l,r]);async function k(){if(!c)return;const t=b.trim(),n=v.trim();if(!t||!n){r.push({kind:"error",title:"Name and responsible email required"});return}try{const s=await l({path:`/api/v1/organizations/${d}/bots`,method:"POST",body:{name:t,responsible_email:n}});h(s),N(""),g(""),x(!1),await p()}catch(s){if(s&&typeof s=="object"&&"status"in s&&s.status===401)return;const j=s&&typeof s=="object"&&"message"in s?String(s.message):"";r.push({kind:"error",title:"Create failed",detail:j})}}async function T(t,n){if(c&&confirm(`Revoke bot "${n??"Unnamed bot"}"? This removes the bot from the organization.`))try{await l({path:`/api/v1/organizations/${d}/members/${t}`,method:"DELETE"}),await p()}catch(s){if(s&&typeof s=="object"&&"status"in s&&s.status===401)return;const j=s&&typeof s=="object"&&"message"in s?String(s.message):"";r.push({kind:"error",title:"Revoke failed",detail:j})}}async function R(t){try{await navigator.clipboard.writeText(t),r.push({kind:"success",title:"Copied"})}catch{r.push({kind:"error",title:"Copy failed"})}}return a.useEffect(()=>{p()},[p]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(z,{children:[e.jsx(O,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-content-primary",children:"Bots"}),e.jsx("div",{className:"mt-1 text-sm text-content-tertiary",children:"Machine accounts for automated workflows."})]}),e.jsxs(o,{onClick:()=>x(!0),disabled:!u,children:[e.jsx(F,{className:"h-4 w-4"}),"New bot"]})]})}),e.jsxs($,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"text-xs text-content-muted",children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"py-2 pr-3",children:"Bot"}),e.jsx("th",{className:"py-2 pr-3",children:"Responsible"}),e.jsx("th",{className:"py-2 pr-3",children:"Created"}),e.jsx("th",{className:"py-2 pr-3"})]})}),e.jsxs("tbody",{children:[C.map(t=>e.jsxs("tr",{className:"border-b border-border-subtle",children:[e.jsx("td",{className:"py-3 pr-3",children:e.jsxs("div",{className:"flex items-center gap-2 font-medium text-content-primary",children:[e.jsx(q,{className:"h-4 w-4 text-accent-text"}),t.name??"Unnamed bot"]})}),e.jsx("td",{className:"py-3 pr-3 text-content-secondary",children:t.responsible_email}),e.jsx("td",{className:"py-3 pr-3 text-xs text-content-tertiary",children:t.created_at}),e.jsx("td",{className:"py-3 pr-3",children:e.jsx("div",{className:"flex justify-end",children:e.jsxs(o,{variant:"danger",size:"sm",disabled:!u,onClick:()=>T(t.account_id,t.name??null),children:[e.jsx(D,{className:"h-4 w-4"}),"Revoke"]})})})]},t.account_id)),C.length===0&&!E?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"py-6 text-center text-sm text-content-muted",children:"No bots yet."})}):null]})]})}),e.jsx("div",{className:"mt-3 text-xs text-content-muted",children:"Note: Bot API keys are only shown at creation time."})]})]}),e.jsx(S,{open:P,title:"Create bot",onClose:()=>x(!1),onSubmit:k,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"botName",children:"Name"}),e.jsx(B,{id:"botName",value:b,onChange:t=>N(t.target.value),placeholder:"CI Bot"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"email",children:"Responsible email"}),e.jsx(B,{id:"email",value:v,onChange:t=>g(t.target.value),placeholder:"ops@example.com"})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{variant:"secondary",onClick:()=>x(!1),children:"Cancel"}),e.jsx(o,{onClick:k,disabled:!u,children:"Create"})]})]})}),e.jsx(S,{open:!!i,title:"Bot API key (save now)",onClose:()=>h(null),children:i?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{tone:"neon",children:"bot"}),e.jsx("div",{className:"text-sm font-semibold text-content-primary",children:i.name})]}),e.jsx("div",{className:"text-sm text-content-tertiary",children:"This API key is shown once. Copy it somewhere safe."}),e.jsxs("div",{className:"rounded-2xl border border-border bg-surface-subtle p-4",children:[e.jsx("div",{className:"text-xs text-content-muted",children:"API key"}),e.jsx("div",{className:"mt-1 break-all font-mono text-xs text-content-primary",children:i.api_key})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(o,{variant:"secondary",onClick:()=>R(i.api_key),children:[e.jsx(U,{className:"h-4 w-4"}),"Copy"]}),e.jsx(o,{onClick:()=>h(null),children:"Done"})]})]}):null})]})}export{ne as default};
