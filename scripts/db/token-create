#!/usr/bin/env bash
set -euo pipefail

if [ -z "${COURIER_DATABASE_URL:-}" ]; then
  echo "Error: COURIER_DATABASE_URL environment variable is not set" >&2
  exit 1
fi

if [ $# -ne 2 ]; then
  echo "Usage: $0 <account-id> <name>" >&2
  echo "Create a new API token for an account" >&2
  echo "  account-id: The account ID to create the token for" >&2
  echo "  name: Name for the token" >&2
  exit 1
fi

ACCOUNT_ID="$1"
TOKEN_NAME="$2"

if ! [[ "$ACCOUNT_ID" =~ ^[0-9]+$ ]]; then
  echo "Error: Account ID must be a number" >&2
  exit 1
fi

# Generate a random 32-byte token and encode as hex
TOKEN=$(openssl rand -hex 32)

# Hash the token using SHA-256 and convert to bytea format
TOKEN_HASH=$(echo -n "$TOKEN" | openssl dgst -sha256 -binary | xxd -p -c 256)

if ! RESULT=$(echo "INSERT INTO api_key (account_id, name, hash) VALUES (:account_id, :'token_name', :'token_hash') RETURNING id, account_id, name, created_at;" | psql "$COURIER_DATABASE_URL" -v account_id="$ACCOUNT_ID" -v token_name="$TOKEN_NAME" -v token_hash="\\x$TOKEN_HASH" -t 2>&1); then
  echo "Error: Failed to create API token" >&2
  echo "$RESULT" >&2
  exit 1
fi

echo "API token created successfully:"
echo "$RESULT" | sed 's/^/  /'
echo ""
echo "TOKEN (save this, it will not be shown again):"
echo "  $TOKEN"
